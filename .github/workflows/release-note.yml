name: Generate Release Note

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  release-note:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Generate release note
        id: generate
        uses: gorilli-team/release-note-ai@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          generate_summary: true
          model: claude-3-5-sonnet-20241022
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Display generated release note
        run: |
          echo "Release Note Generated:"
          echo '${{ steps.generate.outputs.release_note }}' | jq .

      - name: Save release note artifact
        run: |
          mkdir -p release-notes
          echo '${{ steps.generate.outputs.release_note }}' > release-notes/pr-${{ github.event.pull_request.number }}.json

      - name: Upload release note artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-note-pr-${{ github.event.pull_request.number }}
          path: release-notes/pr-${{ github.event.pull_request.number }}.json
          retention-days: 90

      - name: Comment on PR with release note
        uses: actions/github-script@v7
        with:
          script: |
            const releaseNote = JSON.parse('${{ steps.generate.outputs.release_note }}');
            const changes = releaseNote.changes.map(c => `- ${c}`).join('\n');
            const tags = releaseNote.tags?.map(t => `\`${t}\``).join(', ') ?? '';

            const body = `## ðŸ¤– Generated Release Note
            
            **${releaseNote.title}**
            
            ${releaseNote.description}
            
            ### Changes
            ${changes}
            
            ### Tags
            ${tags}
            
            ---
            *Generated by [release-note-ai](https://github.com/gorilli-team/release-note-ai)*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: body
            });
